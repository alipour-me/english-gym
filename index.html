<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Gym">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/brain.png">

    <title>Gemini 2.5 Gym</title>
    
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1e130c 0%, #9a8478 100%); /* ÿ™ŸÖ ÿ¨ÿØ€åÿØ (ŸÇŸáŸàŸá‚Äåÿß€å ŸÖÿØÿ±ŸÜ) */
            --glass: rgba(255, 255, 255, 0.1);
            --border: rgba(255, 255, 255, 0.2);
            --text: #ffffff;
            --accent: #ff9f43;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            margin: 0;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
        }

        .container {
            background: var(--glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        #settings-panel {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 12px;
        }
        
        input {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            width: 100%;
            box-sizing: border-box;
            outline: none;
        }

        h2 { margin: 0 0 15px 0; color: var(--accent); font-size: 1.6rem; letter-spacing: -1px;}

        .target-box {
            background: rgba(0,0,0,0.25);
            padding: 25px;
            border-radius: 18px;
            margin-bottom: 15px;
            font-size: 1.4rem;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--border);
            line-height: 1.5;
        }

        #source-badge {
            font-size: 0.8rem;
            margin-bottom: 20px;
            opacity: 0.8;
            display: block;
            min-height: 1.2em;
            padding: 5px;
            border-radius: 5px;
        }

        .word { padding: 4px 6px; border-radius: 6px; transition: 0.2s;}
        .word-correct { color: #2ecc71; background: rgba(46, 204, 113, 0.15); }
        .word-error { color: #ff6b6b; text-decoration: underline wavy #ff6b6b; }
        
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        button {
            padding: 16px;
            font-size: 1rem;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            color: white;
            font-weight: 700;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.96); }
        
        .btn-gen { background: linear-gradient(135deg, #e67e22, #d35400); grid-column: span 2; }
        .btn-listen { background: #f1c40f; color: #333; }
        .btn-check { background: #27ae60; }
        .btn-settings { background: transparent; border: 1px solid var(--border); font-size: 0.8rem; margin-top: 25px; opacity: 0.5; padding: 10px;}

        select {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: rgba(0,0,0,0.4); color: white; border-radius: 12px; border: 1px solid var(--border);
            font-size: 1rem; outline: none;
        }
        
        #score { margin-top: 15px; font-weight: bold; font-size: 1.2rem;}
    </style>
</head>
<body>

<div class="container">
    <h2>‚ú® Gemini 2.5 Gym</h2>

    <form id="settings-panel" onsubmit="event.preventDefault(); saveKeys();">
        <div style="font-size:0.9rem; margin-bottom:5px;">üîê API Setup</div>
        <input type="text" name="username" autocomplete="username" style="display:none;">
        <input type="password" id="inp-gemini" placeholder="Paste Google Gemini Key" autocomplete="new-password">
        <input type="password" id="inp-azure" placeholder="Paste Azure Key" autocomplete="new-password">
        <input type="text" id="inp-region" placeholder="Region (e.g. eastus)" value="eastus">
        <button type="submit" style="background:#3498db; margin-top:10px;">Save & Start</button>
    </form>

    <div id="main-app">
        <select id="level-input">
            <option value="1">Level A1: Words</option>
            <option value="2">Level A2: Basic Phrases</option>
            <option value="3">Level B1: Sentences</option>
            <option value="4">Level B2: Complex</option>
            <option value="5">Level C1: Advanced/Business</option>
        </select>

        <div class="target-box" id="target-container">Tap Generate...</div>
        
        <span id="source-badge"></span>

        <div class="actions">
            <button id="btn-gen" class="btn-gen" onclick="generate()">‚ö° AI Generate</button>
            <button class="btn-listen" onclick="listen()">üîä Listen</button>
            <button id="btn-check" class="btn-check" onclick="check()">üé§ Check</button>
        </div>
        
        <div id="score"></div>
        <button class="btn-settings" onclick="toggleSettings()">‚öôÔ∏è API Keys</button>
    </div>
</div>

<script>
    let KEYS = {
        gemini: localStorage.getItem("gemini_key") || "",
        azure: localStorage.getItem("azure_key") || "",
        region: localStorage.getItem("azure_region") || "eastus"
    };

    function checkKeys() {
        if(!KEYS.gemini || !KEYS.azure) {
            document.getElementById('settings-panel').style.display = 'flex';
            document.getElementById('main-app').style.opacity = '0.3';
            document.getElementById('main-app').style.pointerEvents = 'none';
        } else {
            document.getElementById('settings-panel').style.display = 'none';
            document.getElementById('main-app').style.opacity = '1';
            document.getElementById('main-app').style.pointerEvents = 'all';
        }
    }
    
    function saveKeys() {
        const g = document.getElementById('inp-gemini').value;
        const a = document.getElementById('inp-azure').value;
        const r = document.getElementById('inp-region').value;
        
        if(g && a) {
            localStorage.setItem("gemini_key", g);
            localStorage.setItem("azure_key", a);
            localStorage.setItem("azure_region", r);
            KEYS = { gemini: g, azure: a, region: r };
            checkKeys();
            alert("Keys Saved!");
        } else {
            alert("Please fill both keys.");
        }
    }

    function toggleSettings() {
        const panel = document.getElementById('settings-panel');
        if(panel.style.display === 'none') {
            panel.style.display = 'flex';
            document.getElementById('inp-gemini').value = KEYS.gemini;
            document.getElementById('inp-azure').value = KEYS.azure;
        } else {
            panel.style.display = 'none';
        }
    }

    checkKeys();

    // --- FALLBACK VOCABULARY ---
    const vocabulary = {
        nouns: ["opportunity", "challenge", "solution", "strategy", "innovation", "development", "community", "experience", "technology", "environment"],
        verbs: ["create", "develop", "understand", "consider", "remember", "achieve", "improve", "support", "discover", "manage"],
        adjectives: ["creative", "effective", "successful", "important", "necessary", "available", "potential", "significant", "global", "local"]
    };
    
    const rand = (a) => a[Math.floor(Math.random()*a.length)];
    const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
    
    let currentText = "";
    const targetEl = document.getElementById('target-container');
    const sourceBadge = document.getElementById('source-badge');
    const btnGen = document.getElementById('btn-gen');

    // --- üíé NEW MODEL LIST (BASED ON YOUR SCREENSHOT) ---
    // We try the newest one first. If it fails, we go to the "lite" one.
    const MODEL_QUEUE = [
        "gemini-2.5-flash",                  // Newest & Fastest
        "gemini-2.0-flash-lite-preview-02-05", // Lite version (often better quota)
        "gemini-2.0-flash",                  // Standard 2.0
    ];

    async function fetchGemini(modelName, prompt) {
        console.log("Attempting:", modelName);
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${KEYS.gemini}`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const data = await response.json();
        
        if(data.error) {
            throw new Error(`[${modelName}] ${data.error.message}`);
        }
        return data.candidates[0].content.parts[0].text;
    }

    async function generate() {
        const level = document.getElementById('level-input').value;
        btnGen.disabled = true;
        btnGen.innerText = "Thinking...";
        document.getElementById('score').innerText = "";
        
        try {
            if (!KEYS.gemini) throw new Error("No API Key");
            
            // Prompt Engineering
            const prompt = `Generate a random, useful English sentence (Level ${level}). 
            Constraints: Max 15 words. No markdown. Output ONLY text.`;
            
            let success = false;

            // --- SMART RETRY LOOP ---
            for (const model of MODEL_QUEUE) {
                try {
                    currentText = await fetchGemini(model, prompt);
                    
                    // Success!
                    sourceBadge.innerHTML = `‚ú® Source: <b>${model}</b>`;
                    sourceBadge.style.color = "#2ecc71"; // Green
                    success = true;
                    break; // Exit loop
                } catch (err) {
                    console.warn(`Skipping ${model}:`, err.message);
                }
            }

            if (!success) throw new Error("All Online Models Failed");

            currentText = currentText.replace(/["*]/g, '').trim();

        } catch(e) {
            console.warn("OFFLINE FALLBACK:", e);
            currentText = generateLocal(level);
            sourceBadge.innerHTML = "üì¶ Source: <b>Offline Engine</b> (Internet/Quota Issue)";
            sourceBadge.style.color = "#f1c40f"; // Yellow
        }
        
        render(currentText);
        btnGen.disabled = false;
        btnGen.innerText = "‚ö° AI Generate";
    }

    function generateLocal(lvl) {
        // Simple fallback generator
        return capitalize(`The ${rand(vocabulary.adjectives)} ${rand(vocabulary.nouns)} can ${rand(vocabulary.verbs)} the ${rand(vocabulary.nouns)}`);
    }

    function render(txt) {
        targetEl.innerHTML = "";
        txt.split(" ").forEach(w => {
            const s = document.createElement("span");
            s.className = "word"; s.innerText = w;
            targetEl.appendChild(s);
            targetEl.appendChild(document.createTextNode(" "));
        });
    }

    function listen() {
        if(!currentText) return;
        const u = new SpeechSynthesisUtterance(currentText);
        u.lang = "en-US"; window.speechSynthesis.speak(u);
    }

    function check() {
        if(!currentText) return;
        const btn = document.getElementById('btn-check');
        const old = btn.innerText;
        btn.disabled = true; btn.innerText = "üé§ ...";

        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(KEYS.azure, KEYS.region);
        speechConfig.speechRecognitionLanguage = "en-US";
        const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
        
        // Config: 100-mark system, Phoneme level granularity
        const pron = new SpeechSDK.PronunciationAssessmentConfig(currentText, 2, 2, true); 
        
        const reco = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
        pron.applyTo(reco);

        reco.recognizeOnceAsync(res => {
            btn.disabled = false; btn.innerText = old; reco.close();
            if(res.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                const r = SpeechSDK.PronunciationAssessmentResult.fromResult(res);
                const score = r.accuracyScore;
                
                document.getElementById('score').innerHTML = `Score: <span style="color:${score>=80?'#2ecc71':'#ff6b6b'}">${score}</span>`;
                
                const json = JSON.parse(res.json);
                const spans = document.querySelectorAll('.word');
                if(json.NBest && json.NBest.length>0) {
                    json.NBest[0].Words.forEach((w, i) => {
                        if(i < spans.length) {
                            spans[i].className = "word " + (w.PronunciationAssessment.ErrorType==="None" && w.PronunciationAssessment.AccuracyScore>=80 ? "word-correct" : "word-error");
                        }
                    });
                }
            }
        });
    }
</script>
</body>
</html>
