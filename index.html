<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e130c">
    <meta name="msapplication-navbutton-color" content="#1e130c">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="English Gym">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/brain.png">

    <title>English Gym</title>
    
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1e130c 0%, #9a8478 100%); 
            --glass: rgba(255, 255, 255, 0.1);
            --border: rgba(255, 255, 255, 0.2);
            --text: #ffffff;
            --accent: #ff9f43;
        }

        html, body {
            height: 100%; /* Ø§Ø±ØªÙØ§Ø¹ Ú©Ø§Ù…Ù„ */
            margin: 0;
            padding: 0;
            background: var(--bg-gradient); /* Ø§Ø¹Ù…Ø§Ù„ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø¨Ù‡ Ú©Ù„ ØµÙØ­Ù‡ */
            background-attachment: fixed; /* Ø«Ø§Ø¨Øª Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ú¯Ø±Ø§Ø¯ÛŒÙ†Øª Ù‡Ù†Ú¯Ø§Ù… Ø§Ø³Ú©Ø±ÙˆÙ„ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: var(--text);
            padding: 20px;
            padding-top: env(safe-area-inset-top); /* Ø­ÙØ¸ ÙØ§ØµÙ„Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ø§Ú† Ø¢ÛŒÙÙˆÙ† */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
            box-sizing: border-box; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§ÙÙ‚ÛŒ */
        }

        .container {
            background: var(--glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        #settings-panel {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 12px;
        }
        
        input {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            width: 100%;
            box-sizing: border-box;
            outline: none;
        }

        h2 { margin: 0 0 15px 0; color: var(--accent); font-size: 1.6rem; letter-spacing: -1px;}

        h5 { color: var(--accent); font-size: 0.8rem; letter-spacing: 0px; margin-top: 15px;}
        h5 a { color: var(--accent); text-decoration: none;}

        .target-box {
            background: rgba(0,0,0,0.25);
            padding: 25px;
            border-radius: 18px;
            margin-bottom: 15px;
            font-size: 1.4rem;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--border);
            line-height: 1.5;
        }

        #source-badge {
            font-size: 0.8rem;
            margin-bottom: 10px;
            opacity: 0.8;
            display: block;
            min-height: 1.2em;
            padding: 5px;
            border-radius: 5px;
        }

        .word { padding: 2px 2px; border-radius: 6px; transition: 0.2s;}
        .word-correct { color: #2ecc71; background: rgba(46, 204, 113, 0.15); }
        .word-error { color: #ff6b6b; text-decoration: underline wavy #ff6b6b; }
        
        .voice-controls {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        button {
            padding: 16px;
            font-size: 1rem;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            color: white;
            font-weight: 700;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.96); }
        
        .btn-gen { background: linear-gradient(135deg, #e67e22, #d35400); grid-column: span 2; }
        .btn-listen { background: #f1c40f; color: #333; }
        .btn-check { background: #27ae60; }
        .btn-settings { background: transparent; border: 1px solid var(--border); font-size: 0.8rem; margin-top: 25px; opacity: 0.5; padding: 10px;}

        select {
            width: 100%; padding: 10px; 
            background: rgba(0,0,0,0.4); color: white; border-radius: 10px; border: 1px solid var(--border);
            font-size: 0.9rem; outline: none;
        }
        
        #score { margin-top: 15px; font-weight: bold; font-size: 1.2rem;}
    </style>
</head>
<body>

<div class="container">
    <h2>âœ¨ English Gym</h2>

    <form id="settings-panel" onsubmit="event.preventDefault(); saveKeys();">
        <div style="font-size:0.9rem; margin-bottom:5px;">ğŸ” API Setup</div>
        <input type="text" name="username" autocomplete="username" style="display:none;">
        <input type="password" id="inp-gemini" placeholder="Paste Google Gemini Key" autocomplete="new-password">
        <input type="password" id="inp-azure" placeholder="Paste Azure Key" autocomplete="new-password">
        <input type="text" id="inp-region" placeholder="Region (e.g. eastus)" value="eastus">
        <button type="submit" style="background:#3498db; margin-top:10px;">Save & Start</button>
    </form>

    <div id="main-app">
        <select id="level-input" style="margin-bottom: 15px;">
            <option value="1">Level 1: Single Word (A1)</option>
            <option value="2">Level 2: Short Phrase (A2)</option>
            <option value="3">Level 3: Simple Sentence (B1)</option>
            <option value="4">Level 4: Complex Sentence (B2)</option>
            <option value="5">Level 5: Business/Professional (C1)</option>
        </select>

        <div class="target-box" id="target-container">Tap Generate...</div>
        <span id="source-badge"></span>

        <div class="voice-controls">
            <select id="voice-name">
                <option value="en-US-JennyNeural">ğŸ‘© Jenny (Natural)</option>
                <option value="en-US-GuyNeural">ğŸ‘¨ Guy (Natural)</option>
                <option value="en-US-AriaNeural">ğŸ‘© Aria (Confident)</option>
                <option value="en-US-DavisNeural">ğŸ‘¨ Davis (Casual)</option>
                <option value="en-US-AmberNeural">ğŸ‘© Amber (Soft)</option>
                <option value="en-US-SteffanNeural">ğŸ‘¨ Steffan (Warm)</option>
            </select>
            <select id="voice-speed">
                <option value="0%">Normal</option>
                <option value="-15%">Slow</option>
                <option value="-30%">Slower</option>
                <option value="-50%">Super Slow</option>
            </select>
        </div>

        <div class="actions">
            <button id="btn-gen" class="btn-gen" onclick="generate()">âš¡ Generate</button>
            <button class="btn-listen" onclick="listen()">ğŸ”Š</button>
            <button id="btn-check" class="btn-check" onclick="check()">ğŸ¤</button>
        </div>
        
        <div id="score"></div>
        <button class="btn-settings" onclick="toggleSettings()">âš™ï¸ API Keys</button>
    </div>
    <h5 style="text-decoration: none;"><a href="https://alipour.me" target="_blank">âœ¨ Alireza Alipour âœ¨</a></h5>
</div>
<script>
    let KEYS = {
        gemini: localStorage.getItem("gemini_key") || "",
        azure: localStorage.getItem("azure_key") || "",
        region: localStorage.getItem("azure_region") || "eastus"
    };

    function checkKeys() {
        if(!KEYS.gemini || !KEYS.azure) {
            document.getElementById('settings-panel').style.display = 'flex';
            document.getElementById('main-app').style.opacity = '0.3';
            document.getElementById('main-app').style.pointerEvents = 'none';
        } else {
            document.getElementById('settings-panel').style.display = 'none';
            document.getElementById('main-app').style.opacity = '1';
            document.getElementById('main-app').style.pointerEvents = 'all';
        }
    }
    
    function saveKeys() {
        const g = document.getElementById('inp-gemini').value;
        const a = document.getElementById('inp-azure').value;
        const r = document.getElementById('inp-region').value;
        
        if(g && a) {
            localStorage.setItem("gemini_key", g);
            localStorage.setItem("azure_key", a);
            localStorage.setItem("azure_region", r);
            KEYS = { gemini: g, azure: a, region: r };
            checkKeys();
            alert("Keys Saved!");
        } else {
            alert("Please fill both keys.");
        }
    }

    function toggleSettings() {
        const panel = document.getElementById('settings-panel');
        if(panel.style.display === 'none') {
            panel.style.display = 'flex';
            document.getElementById('inp-gemini').value = KEYS.gemini;
            document.getElementById('inp-azure').value = KEYS.azure;
        } else {
            panel.style.display = 'none';
        }
    }

    checkKeys();

    const vocab = {
        subjects: ["The cat", "My friend", "A stranger", "The teacher", "This project", "Our team", "The system", "Technology", "The weather", "A doctor", "The artist", "This computer", "The government", "A driver", "My boss", "The solution", "An engineer", "The music", "History", "Nature"],
        verbs: ["creates", "improves", "destroys", "considers", "remembers", "understands", "develops", "changes", "requires", "follows", "guides", "analyzes", "builds", "finds", "loses", "needs", "wants", "supports", "challenges", "discovers"],
        adjectives: ["creative", "global", "effective", "dangerous", "beautiful", "complex", "simple", "modern", "ancient", "rapid", "slow", "intelligent", "expensive", "cheap", "necessary", "impossible", "real", "fake", "huge", "tiny"],
        objects: ["the future", "a new strategy", "the big problem", "a simple idea", "the environment", "my question", "the answer", "a fast car", "the blue sky", "an old book", "the tasty food", "a difficult exam", "the software", "a golden opportunity", "the silence", "a secret"],
        adverbs: ["quickly", "slowly", "suddenly", "carefully", "actually", "probably", "certainly", "eventually", "recently", "always", "never", "often", "rarely", "usually"],
        conjunctions: ["because", "although", "while", "but", "so", "if", "when", "before", "after"],
        business_terms: ["synergy", "paradigm shift", "ROI", "bandwidth", "deliverables", "touchpoint", "leverage", "scalability", "best practice", "ecosystem"],
        l1: ["Apple", "Book", "Car", "Dog", "Eat", "Fast", "Go", "Happy", "Ice", "Jump", "Key", "Love", "Moon", "No", "Open", "Pen", "Quiet", "Red", "Sun", "Time", "Up", "Van", "Water", "Yes", "Zoo", "Bird", "Cat", "Door", "Fish", "Good"],
        l2: ["Good morning", "How are you", "Thank you", "Excuse me", "I am sorry", "Turn left", "Go straight", "Come here", "Sit down", "Stand up", "Open the door", "Close the window", "A cup of coffee", "My blue car", "Very good", "Not bad", "See you later", "Have a nice day"]
    };

    const rand = (a) => a[Math.floor(Math.random()*a.length)];
    const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
    
    let currentText = "";
    const targetEl = document.getElementById('target-container');
    const sourceBadge = document.getElementById('source-badge');
    const btnGen = document.getElementById('btn-gen');

    // --- ğŸš€ PRIORITY FIX ---
    // Moved 'gemini-1.5-flash' to the TOP because it has the best free quota.
    const MODEL_QUEUE = [
        "gemini-1.5-flash",          // 15 RPM (Most Reliable)
        "gemini-2.5-flash",          // Newest (Low Quota)
        "gemini-2.0-flash-lite-preview-02-05", 
        "gemini-2.0-flash"
    ];

    async function fetchGemini(modelName, prompt) {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${KEYS.gemini}`, {
            method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const data = await response.json();
        if(data.error) throw new Error(`[${modelName}] ${data.error.message}`);
        return data.candidates[0].content.parts[0].text;
    }

    function getPrompt(level) {
        const topics = ["Technology", "Travel", "Daily Life", "Food", "Work", "Nature", "Emotions", "Space", "History"];
        const randomTopic = rand(topics);
        switch(level) {
            case "1": return `Generate exactly ONE unique English word (Noun, Verb, or Adjective). Try to avoid very common words. Just the word.`;
            case "2": return `Generate a useful English idiom or common phrase (2-4 words). Example: 'Break a leg', 'Once in a blue moon'. No periods.`;
            case "3": return `Generate a simple English sentence about ${randomTopic} (Subject + Verb + Object). Approx 6-8 words.`;
            case "4": return `Generate a complex sentence about ${randomTopic} using conjunctions (e.g., although, because). Approx 10-12 words.`;
            case "5": return `Generate a sophisticated sentence about ${randomTopic} using advanced C1 vocabulary.`;
            default: return "Generate a random English sentence.";
        }
    }

    async function generate() {
        const level = document.getElementById('level-input').value;
        btnGen.disabled = true; btnGen.innerText = "Thinking...";
        document.getElementById('score').innerText = "";
        
        try {
            if (!KEYS.gemini) throw new Error("No API Key");
            
            const prompt = getPrompt(level) + " Output ONLY text.";
            
            let success = false;
            for (const model of MODEL_QUEUE) {
                try {
                    currentText = await fetchGemini(model, prompt);
                    sourceBadge.innerHTML = `âœ¨ Source: <b>${model}</b>`;
                    sourceBadge.style.color = "#2ecc71";
                    success = true; break;
                } catch (err) { console.warn(`Skipping ${model}:`, err.message); }
            }
            if (!success) throw new Error("All Online Models Failed");
            currentText = currentText.replace(/["*]/g, '').trim();
        } catch(e) {
            console.warn("OFFLINE FALLBACK:", e);
            currentText = generateLocal(level);
            sourceBadge.innerHTML = "ğŸ“¦ Source: <b>Offline Engine</b> (Randomized)";
            sourceBadge.style.color = "#f1c40f";
        }
        render(currentText);
        btnGen.disabled = false; btnGen.innerText = "âš¡ Generate";
    }

    function generateLocal(lvl) {
        if(lvl == "1") return rand(vocab.l1);
        if(lvl == "2") return rand(vocab.l2);
        
        const subj = rand(vocab.subjects);
        const verb = rand(vocab.verbs);
        const adj = rand(vocab.adjectives);
        const obj = rand(vocab.objects);
        const adv = rand(vocab.adverbs);
        const conj = rand(vocab.conjunctions);
        const bus = rand(vocab.business_terms);

        if(lvl == "3") return `${subj} ${adv} ${verb} ${adj} ${obj}.`;
        if(lvl == "4") return capitalize(`${conj} ${subj} ${verb} ${obj}, it is ${adj}.`);
        if(lvl == "5") return `The ${bus} essentially ${verb} the ${bus} regarding ${obj}.`;
        return "Learning English opens many doors.";
    }

    function render(txt) {
        targetEl.innerHTML = "";
        txt.split(" ").forEach(w => {
            const s = document.createElement("span");
            s.className = "word"; s.innerText = w;
            targetEl.appendChild(s);
            targetEl.appendChild(document.createTextNode(" "));
        });
    }

    function listen() {
        if(!currentText) return;
        const btnListen = document.querySelector('.btn-listen');
        const originalText = btnListen.innerText;
        btnListen.disabled = true; btnListen.innerText = "â³ Loading...";

        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(KEYS.azure, KEYS.region);
        const selectedVoice = document.getElementById('voice-name').value;
        const selectedSpeed = document.getElementById('voice-speed').value;

        const ssml = `
        <speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="en-US">
            <voice name="${selectedVoice}">
                <prosody rate="${selectedSpeed}">
                    ${currentText}
                </prosody>
            </voice>
        </speak>`;

        const audioConfig = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
        const synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, audioConfig);

        synthesizer.speakSsmlAsync(
            ssml,
            result => {
                btnListen.disabled = false; btnListen.innerText = originalText;
                synthesizer.close();
            },
            error => {
                console.error("TTS Error:", error);
                btnListen.disabled = false; btnListen.innerText = "Error";
                synthesizer.close();
            }
        );
    }

    function check() {
        if(!currentText) return;
        const btn = document.getElementById('btn-check');
        const old = btn.innerText;
        btn.disabled = true; btn.innerText = "ğŸ¤ ...";

        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(KEYS.azure, KEYS.region);
        speechConfig.speechRecognitionLanguage = "en-US";
        const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
        const pron = new SpeechSDK.PronunciationAssessmentConfig(currentText, 2, 2, true); 
        const reco = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
        pron.applyTo(reco);

        reco.recognizeOnceAsync(res => {
            btn.disabled = false; btn.innerText = old; reco.close();
            if(res.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                const r = SpeechSDK.PronunciationAssessmentResult.fromResult(res);
                const score = r.accuracyScore;
                document.getElementById('score').innerHTML = `Score: <span style="color:${score>=80?'#2ecc71':'#ff6b6b'}">${score}</span>`;
                const json = JSON.parse(res.json);
                const spans = document.querySelectorAll('.word');
                if(json.NBest && json.NBest.length>0) {
                    json.NBest[0].Words.forEach((w, i) => {
                        if(i < spans.length) {
                            spans[i].className = "word " + (w.PronunciationAssessment.ErrorType==="None" && w.PronunciationAssessment.AccuracyScore>=80 ? "word-correct" : "word-error");
                        }
                    });
                }
            }
        });
    }
</script>
</body>
</html>
