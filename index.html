<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e130c">
    <meta name="apple-mobile-web-app-title" content="AI English Gym">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/brain.png">

    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <title>AI English Gym</title>
    
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1e130c 0%, #9a8478 100%); 
            --glass: rgba(255, 255, 255, 0.1);
            --border: rgba(255, 255, 255, 0.2);
            --text: #ffffff;
            --accent: #ff9f43;
        }

        html {
            height: 100%;
            background-color: #1e130c; 
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            background-size: cover;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: var(--text);
            margin: 0;
            padding: env(safe-area-inset-top) 0 20px 0; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
            box-sizing: border-box;
        }

        .container {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            padding: 25px;
            border-radius: 24px;
            width: 90%; 
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            position: relative;
            margin-top: 10px; 
            box-sizing: border-box;
        }

        #settings-panel {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 12px;
        }
        
        input {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            width: 100%;
            box-sizing: border-box;
            outline: none;
        }

        h2 { margin: 0 0 15px 0; color: var(--accent); font-size: 1.6rem; letter-spacing: -1px;}
        h2 span { font-size: 0.8rem; opacity: 0.7; display: block; margin-top: 5px; color: #fff; }

        h5 { color: var(--accent); font-size: 0.8rem; letter-spacing: 0px; margin-top: 20px; opacity: 0.8;}
        h5 a { color: var(--accent); text-decoration: none;}

        .target-box {
            background: rgba(0,0,0,0.25);
            padding: 25px;
            border-radius: 18px;
            margin-bottom: 10px;
            font-size: 1.4rem;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--border);
            line-height: 1.5;
        }

        #translation-text {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1.1rem;
            color: #eeeeee;
            margin-bottom: 15px;
            direction: rtl;
            min-height: 1.5em;
            opacity: 0.9;
            font-weight: 400;
        }

        #source-badge {
            font-size: 0.8rem;
            margin-bottom: 10px;
            opacity: 0.8;
            display: block;
            min-height: 1.2em;
            padding: 5px;
            border-radius: 5px;
        }

        .word { padding: 2px 2px; border-radius: 6px; transition: 0.2s;}
        .word-correct { color: #2ecc71; }
        .word-error { color: #ff6b6b; text-decoration: underline wavy #ff6b6b; }
        
        .voice-controls {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        button {
            padding: 16px;
            font-size: 1rem;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            color: white;
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button:active { transform: scale(0.96); }
        button i { font-size: 1.2rem; }
        
        .btn-gen { background: linear-gradient(135deg, #f35422, #fe8235); grid-column: span 3; } 
        .btn-listen { background: #f1c40f; color: #333; }
        .btn-check { background: #27ae60; }
        .btn-trans { background: #9b59b6; }

        /* ‚öôÔ∏è CENTERED SETTINGS BUTTON */
        .btn-settings { 
            background: transparent; 
            border: 1px solid var(--border); 
            font-size: 0.8rem; 
            margin-top: 25px; 
            opacity: 0.5; 
            padding: 10px 20px;
            border-radius: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: fit-content;
        }

        select {
            width: 100%; padding: 10px; 
            background: rgba(0,0,0,0.4); color: white; border-radius: 10px; border: 1px solid var(--border);
            font-size: 0.9rem; outline: none;
        }
        
        #score { margin-top: 15px; font-weight: bold; font-size: 1.2rem;}
    </style>
</head>
<body>

<div class="container">
    <h2>‚ö° English Gym <span>(with AI)</span></h2>

    <form id="settings-panel" onsubmit="event.preventDefault(); saveKeys();">
        <div style="font-size:0.9rem; margin-bottom:5px;">üîê API Setup</div>
        <input type="text" name="username" autocomplete="username" style="display:none;">
        <input type="password" id="inp-groq" placeholder="Paste Groq API Key (gsk_...)" autocomplete="new-password">
        <input type="password" id="inp-azure" placeholder="Paste Azure Key" autocomplete="new-password">
        <input type="text" id="inp-region" placeholder="Region (e.g. eastus)" value="eastus">
        <button type="submit" style="background:#f35422; margin-top:10px;">Save & Start</button>
        <div style="font-size: 0.7rem; margin-top:5px; opacity:0.7;">Keys are saved on your device.</div>
    </form>

    <div id="main-app">
        <select id="level-input" style="margin-bottom: 15px;">
            <option value="1">Level 1: Single Word (A1)</option>
            <option value="2">Level 2: Short Phrase (A2)</option>
            <option value="3">Level 3: Simple Sentence (B1)</option>
            <option value="4">Level 4: Complex Sentence (B2)</option>
            <option value="5">Level 5: Business/Professional (C1)</option>
        </select>

        <div class="target-box" id="target-container">Tap Generate...</div>
        
        <div id="translation-text"></div>
        
        <span id="source-badge"></span>

        <div class="voice-controls">
            <select id="voice-name">
                <option value="en-US-AmberNeural">üë© Amber (Soft)</option>
                <option value="en-US-JennyNeural">üë© Jenny (Natural)</option>
                <option value="en-US-GuyNeural">üë® Guy (Natural)</option>
                <option value="en-US-AriaNeural">üë© Aria (Confident)</option>
                <option value="en-US-DavisNeural">üë® Davis (Casual)</option>
                <option value="en-US-SteffanNeural">üë® Steffan (Warm)</option>
            </select>
            <select id="voice-speed">
                <option value="0%">Normal</option>
                <option value="-15%">Slow</option>
                <option value="-30%">Slower</option>
                <option value="-50%">Super Slow</option>
            </select>
        </div>

        <div class="actions">
            <button id="btn-gen" class="btn-gen" onclick="generate()">‚ö° Generate</button>
            <button id="btn-listen" class="btn-listen" onclick="listen()"><i class="fas fa-volume-up"></i></button>
            <button id="btn-check" class="btn-check" onclick="check()"><i class="fas fa-microphone"></i></button>
            <button id="btn-trans" class="btn-trans" onclick="translateText()"><i class="fas fa-language"></i></button>
        </div>
        
        <div id="score"></div>
        <button class="btn-settings" onclick="toggleSettings()">‚öôÔ∏è API Keys</button>
    </div>
    <h5 style="text-decoration: none;"><a href="https://alipour.me" target="_blank">‚ú® Alireza Alipour ‚ú®</a></h5>
</div>
<script>
    let KEYS = {
        groq: localStorage.getItem("groq_key") || "", 
        azure: localStorage.getItem("azure_key") || "",
        region: localStorage.getItem("azure_region") || "eastus"
    };

    let history = JSON.parse(localStorage.getItem("gym_history") || "[]");

    function checkKeys() {
        if(!KEYS.groq || !KEYS.azure) {
            document.getElementById('settings-panel').style.display = 'flex';
            document.getElementById('main-app').style.opacity = '0.3';
            document.getElementById('main-app').style.pointerEvents = 'none';
        } else {
            document.getElementById('settings-panel').style.display = 'none';
            document.getElementById('main-app').style.opacity = '1';
            document.getElementById('main-app').style.pointerEvents = 'all';
        }
    }
    
    function saveKeys() {
        const g = document.getElementById('inp-groq').value;
        const a = document.getElementById('inp-azure').value;
        const r = document.getElementById('inp-region').value;
        
        if(g && a) {
            localStorage.setItem("groq_key", g);
            localStorage.setItem("azure_key", a);
            localStorage.setItem("azure_region", r);
            KEYS = { groq: g, azure: a, region: r };
            checkKeys();
            alert("Keys Saved!");
        } else {
            alert("Please fill keys.");
        }
    }

    function toggleSettings() {
        const panel = document.getElementById('settings-panel');
        if(panel.style.display === 'none') {
            panel.style.display = 'flex';
            document.getElementById('inp-groq').value = KEYS.groq;
            document.getElementById('inp-azure').value = KEYS.azure;
        } else {
            panel.style.display = 'none';
        }
    }

    checkKeys();

    const vocab = {
        subjects: ["The scientist", "My neighbor", "A mysterious stranger", "The student", "The team", "The system", "Technology", "The weather", "A doctor", "The artist", "This computer", "The government", "A driver", "My boss", "The solution", "An engineer", "Music", "History", "Nature", "A dolphin", "The pilot", "A chef", "The writer", "A detective"],
        verbs: ["creates", "improves", "destroys", "considers", "remembers", "understands", "develops", "changes", "requires", "follows", "guides", "analyzes", "builds", "finds", "loses", "needs", "wants", "supports", "challenges", "discovers", "investigates", "doubts", "trusts", "questions"],
        adjectives: ["creative", "global", "effective", "dangerous", "beautiful", "complex", "simple", "modern", "ancient", "rapid", "slow", "intelligent", "expensive", "cheap", "necessary", "impossible", "real", "fake", "huge", "tiny", "silent", "noisy", "calm", "wild"],
        objects: ["the future", "a new strategy", "the big problem", "a simple idea", "the environment", "my question", "the answer", "a fast car", "the blue sky", "an old book", "the tasty food", "a difficult exam", "the software", "a opportunity", "the silence", "a secret", "the truth", "a masterpiece"],
        adverbs: ["quickly", "slowly", "suddenly", "carefully", "actually", "probably", "certainly", "eventually", "recently", "always", "never", "often", "rarely", "usually", "barely", "happily", "sadly", "bravely"],
        conjunctions: ["because", "although", "while", "but", "so", "if", "when", "before", "after", "since", "unless"],
        l1: ["Apple", "Book", "Car", "Dog", "Eat", "Fast", "Go", "Happy", "Ice", "Jump", "Key", "Love", "Moon", "No", "Open", "Pen", "Quiet", "Red", "Sun", "Time", "Up", "Van", "Water", "Yes", "Zoo", "Bird", "Cat", "Door", "Fish", "Good", "Hat", "Ink", "Kite", "Lamp", "Map", "Nut", "Owl", "Pig", "Run", "Sit"],
        l2: ["Good morning", "How are you", "Thank you", "Excuse me", "I am sorry", "Turn left", "Go straight", "Come here", "Sit down", "Stand up", "Open the door", "Close the window", "A cup of tea", "My blue car", "Very good", "Not bad", "See you later", "Have a nice day", "Good luck", "Well done"]
    };

    const rand = (a) => a[Math.floor(Math.random()*a.length)];
    const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
    
    let currentText = "";
    const targetEl = document.getElementById('target-container');
    const transEl = document.getElementById('translation-text');
    const sourceBadge = document.getElementById('source-badge');
    const btnGen = document.getElementById('btn-gen');

    const MODEL_QUEUE = [
        "llama-3.3-70b-versatile",    // Most stable
        "qwen-2.5-32b",               // Backup
        "gemma2-9b-it"                // Backup 2
    ];

    function setLoading(btnId, isLoading) {
        const btn = document.getElementById(btnId);
        const icon = btn.querySelector('i');
        if (isLoading) {
            btn.disabled = true;
            icon.classList.add('fa-spin');
            if (btnId === 'btn-listen') icon.className = 'fas fa-circle-notch fa-spin';
            if (btnId === 'btn-check') icon.className = 'fas fa-spinner fa-spin';
            if (btnId === 'btn-trans') icon.className = 'fas fa-sync-alt fa-spin';
        } else {
            btn.disabled = false;
            icon.classList.remove('fa-spin');
            if (btnId === 'btn-listen') icon.className = 'fas fa-volume-up';
            if (btnId === 'btn-check') icon.className = 'fas fa-microphone';
            if (btnId === 'btn-trans') icon.className = 'fas fa-language';
        }
    }

    async function fetchGroq(modelName, prompt, systemOverride = null, tempOverride = null) {
        const randomSeed = Math.floor(Math.random() * 1000000);
        
        let systemContent = systemOverride;
        if (!systemContent) {
            const exclusions = history.slice(-10).join(", ");
            systemContent = `You are a creative English tutor. Current Seed: ${randomSeed}. Always generate a FRESH, UNIQUE, and NON-REPETITIVE example. Do NOT use these recent examples: [${exclusions}]. Output ONLY the text.`;
        }

        const temp = tempOverride !== null ? tempOverride : 1.2;

        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${KEYS.groq}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: modelName,
                messages: [
                    { role: "system", content: systemContent },
                    { role: "user", content: prompt }
                ],
                temperature: temp, 
                max_tokens: 1024,
                top_p: 1
            })
        });

        const data = await response.json();
        if(data.error) throw new Error(`[${modelName}] ${data.error.message}`);
        return data.choices[0].message.content;
    }

    function getPrompt(level) {
        const topics = ["Technology", "Travel", "Daily Life", "Food", "Work", "Nature", "Emotions", "Space", "History", "Sports", "Music", "Cinema", "Dreams", "Ocean", "Forest", "City"];
        const randomTopic = rand(topics);
        
        switch(level) {
            case "1": return `Generate exactly ONE unique English word (Noun, Verb, or Adjective). Avoid very common words like 'apple' or 'cat'. Just the word. No punctuation.`;
            case "2": return `Generate a creative English idiom or short phrase (2-4 words). Example: 'Piece of cake', 'Time flies'. No periods.`;
            case "3": return `Generate a simple English sentence about ${randomTopic} (Subject + Verb + Object). Approx 6-8 words.`;
            case "4": return `Generate a complex sentence about ${randomTopic} using conjunctions (e.g., although, because). Approx 10-12 words.`;
            case "5": return `Generate a sophisticated sentence about ${randomTopic} using advanced C1 vocabulary.`;
            default: return "Generate a random English sentence.";
        }
    }

    async function generate() {
        const level = document.getElementById('level-input').value;
        btnGen.disabled = true; btnGen.innerText = "üöÄ Generating...";
        document.getElementById('score').innerText = "";
        transEl.innerText = "";
        
        try {
            if (!KEYS.groq) throw new Error("No Groq Key");
            const prompt = getPrompt(level);
            let success = false;
            
            for (const model of MODEL_QUEUE) {
                try {
                    currentText = await fetchGroq(model, prompt);
                    
                    currentText = currentText.replace(/<think>[\s\S]*?<\/think>/gi, "").trim();
                    currentText = currentText.replace(/<think>[\s\S]*/gi, "").trim();
                    currentText = currentText.replace(/["*]/g, '').trim();

                    if (!currentText || currentText.length < 2) throw new Error("Empty");

                    history.push(currentText);
                    if (history.length > 50) history.shift();
                    localStorage.setItem("gym_history", JSON.stringify(history));

                    sourceBadge.innerHTML = `‚ú® Source: <b>${model}</b>`;
                    sourceBadge.style.color = "#f35422"; 
                    success = true; break;
                } catch (err) { console.warn(`Skipping ${model}:`, err.message); }
            }
            if (!success) throw new Error("All Failed");
            
        } catch(e) {
            console.warn("OFFLINE FALLBACK:", e);
            currentText = generateLocal(level);
            sourceBadge.innerHTML = "üì¶ Source: <b>Offline Engine</b>";
            sourceBadge.style.color = "#f1c40f";
        }
        render(currentText);
        btnGen.disabled = false; btnGen.innerText = "‚ö° Generate";
    }

    async function translateText() {
        if(!currentText) return;
        setLoading('btn-trans', true);
        
        try {
            const prompt = `Translate this text to fluent, natural Persian (Farsi). Output ONLY the translation, no extra explanations. Text: "${currentText}"`;
            const sysPrompt = "You are a professional English to Persian translator. You provide accurate, natural, and high-quality translations.";
            
            let translation = await fetchGroq(MODEL_QUEUE[0], prompt, sysPrompt, 0.3);
            
            translation = translation.replace(/<think>[\s\S]*?<\/think>/gi, "").trim();
            translation = translation.replace(/["*]/g, '').trim();
            
            transEl.innerText = translation;
            
        } catch(e) {
            console.error(e);
            transEl.innerText = "Translation Failed.";
        }
        setLoading('btn-trans', false);
    }

    function generateLocal(lvl) {
        if(lvl == "1") return rand(vocab.l1);
        if(lvl == "2") return rand(vocab.l2);
        const s = rand(vocab.subjects); const v = rand(vocab.verbs); const a = rand(vocab.adjectives); const o = rand(vocab.objects); const ad = rand(vocab.adverbs); const c = rand(vocab.conjunctions);
        if(lvl == "3") return `${s} ${ad} ${v} ${a} ${o}.`;
        if(lvl == "4") return capitalize(`${c} ${s} ${v} ${o}, it is ${a}.`);
        if(lvl == "5") return `The ${a} nature of ${o} significantly ${v} the outcome.`;
        return "Practice makes perfect.";
    }

    function render(txt) {
        targetEl.innerHTML = "";
        txt.split(" ").forEach(w => {
            const s = document.createElement("span");
            s.className = "word"; s.innerText = w;
            targetEl.appendChild(s);
            targetEl.appendChild(document.createTextNode(" "));
        });
    }

    function listen() {
        if(!currentText) return;
        setLoading('btn-listen', true);

        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(KEYS.azure, KEYS.region);
        const selectedVoice = document.getElementById('voice-name').value;
        const selectedSpeed = document.getElementById('voice-speed').value;

        const ssml = `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="en-US"><voice name="${selectedVoice}"><prosody rate="${selectedSpeed}">${currentText}</prosody></voice></speak>`;

        const audioConfig = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
        const synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, audioConfig);

        synthesizer.speakSsmlAsync(ssml,
            result => { 
                setLoading('btn-listen', false);
                synthesizer.close(); 
            },
            error => { 
                console.error("TTS Error:", error); 
                setLoading('btn-listen', false);
                synthesizer.close(); 
            }
        );
    }

    async function check() {
        if(!currentText) { alert("Generate first!"); return; }
        
        setLoading('btn-check', true);
        document.getElementById('score').innerText = "";

        if(!KEYS.azure || !KEYS.region) {
            alert("API Keys Missing!"); 
            setLoading('btn-check', false);
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { autoGainControl: true, echoCancellation: true, noiseSuppression: true } 
            });
            
            const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(KEYS.azure, KEYS.region);
            speechConfig.speechRecognitionLanguage = "en-US";
            
            speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceConnection_InitialSilenceTimeoutMs, "10000"); 
            speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceConnection_EndSilenceTimeoutMs, "3000"); 

            const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
            const pron = new SpeechSDK.PronunciationAssessmentConfig(currentText, 2, 2, true);
            const reco = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
            pron.applyTo(reco);

            reco.recognizeOnceAsync(res => {
                stream.getTracks().forEach(track => track.stop());
                setLoading('btn-check', false);
                reco.close();
                
                if(res.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                    const r = SpeechSDK.PronunciationAssessmentResult.fromResult(res);
                    document.getElementById('score').innerHTML = `Score: <span style="color:${r.accuracyScore>=80?'#2ecc71':'#ff6b6b'}">${r.accuracyScore}</span>`;
                    
                    const json = JSON.parse(res.json);
                    const spans = document.querySelectorAll('.word');
                    if(json.NBest && json.NBest.length>0) {
                        json.NBest[0].Words.forEach((w, i) => {
                            if(i < spans.length) {
                                spans[i].className = "word " + (w.PronunciationAssessment.ErrorType==="None" && w.PronunciationAssessment.AccuracyScore>=80 ? "word-correct" : "word-error");
                            }
                        });
                    }
                } else if (res.reason === SpeechSDK.ResultReason.NoMatch) {
                    alert("Could not hear you clearly. Please try again.");
                } else if (res.reason === SpeechSDK.ResultReason.Canceled) {
                    alert("Connection Error. Check Key/Internet.");
                }
            });

        } catch (e) {
            alert("Mic Error: " + e.message);
            setLoading('btn-check', false);
        }
    }
</script>
</body>
</html>
